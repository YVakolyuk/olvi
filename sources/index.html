<!DOCTYPE html>
<html>
	<head>
	<meta charset="UTF-8" />
		<title>Sample</title>
		<link rel="stylesheet" href="style.css" type="text/css" />
		<script type="text/javascript"
			src="http://maps.googleapis.com/maps/api/js?key=AIzaSyDZkCGDCptY1ztDe8EyTV5Zn6mkpgrEMRQ&sensor=true">
		</script>
		<script type="text/javascript" src="https://www.google.com/jsapi"> </script>
		<script type="text/javascript" src="http://scriptjava.net/source/scriptjava/scriptjava.js"></script>
		<script type="text/javascript">
		//------------------------------------------It's all GOOGLE EARTH-------------------------------------------
			var ge;//main GoogleEarth variable
			var reCord;
			var reCord2;
			var refIntId;
			var la;
			var flCreP=0;
			var refIntId;
			var refIntId2;
			google.load("earth", "1", {"other_params":"sensor=false"});

			function init() {
				google.earth.createInstance('map3d', initCB, failureCB);
			}

			function initCB(instance) {
				ge = instance;
				ge.getWindow().setVisibility(true);
				ge.getLayerRoot().enableLayerById(ge.LAYER_BORDERS, true);
	  			ge.getNavigationControl().setVisibility(ge.VISIBILITY_AUTO);
				la = ge.createLookAt('');

			
			}

			function failureCB(errorCode) {
			}

			google.setOnLoadCallback(init);
	
			/*function go() {//функция одиночного запуска слежения, без таймера, назначена на кнопку Go
				getPosition(true);
			}*/
			
			function getPosition(flag) {
			$$a({
				type:'get',//тип запроса: get,post либо head
				url:'http://127.0.0.1/olvi/GETlocalPosition.php',//url адрес файла обработчика
				response:'text',//тип возвращаемого ответа text либо xml
				error:function(num){
					var arr=['Your browser does not support Ajax',
                        'Request failed',
                        'Address does not exist',
                        'The waiting time left'];
					alert(arr[num]);
				},
				success:function (data) {//возвращаемый результат от сервера
					if(flag) {
						reCord = JSON.parse(data);
//						alert("Inner "+reCord);
						getFly();
					}
					else {
						reCord2 = JSON.parse(data);
						//alert(reCord2.altitude);
						chCoord();
					}
				}
			});
			}
			
			function timerSet() {
				if(document.getElementById('ctrlReGetPosition').checked) {
				getPosition(true);
					refIntId = setInterval(function() {getPosition(true);},2000)
				}
				else {
					clearInterval(refIntId);
				}
			}
			
/*			function chCoord() { //предполагаемая функция для загрузки тестовых координат в базу данных
				alert("!!!!");
				var lat = Number(reCord2.latitude)+0.0005;
				var lng = Number(reCord2.latitude)+0.0001;
				var alt = Number(reCord2.latitude)+10;
				$$a({
					type:'post',//тип запроса: get,post либо head
					url:'http://127.0.0.1/olvi/POSTnewMarkerTrace.php',//url адрес файла обработчика
					data:{'lat':lat,'lng':lng,'alt':alt},//параметры запроса
					response:'text',//тип возвращаемого ответа text либо xml
					success:function (data) {//возвращаемый результат от сервера
						alert(data);
					}
				});
			}*/
			
			var placemark;
			var icon;
			var style;
			var point;
			var lineStringPlacemark;
			var lineString;
			var lineStyle;
			function getFly() {
					//alert("getFly()"+reCord);
					if(!flCreP) {
						placemark = ge.createPlacemark('');
						icon = ge.createIcon('');
						style = ge.createStyle(''); //создает новый стиль
						point = ge.createPoint('');
						
						lineStringPlacemark = ge.createPlacemark('');
						lineString = ge.createLineString('');
						
						
						icon.setHref('http://127.0.0.1/olvi/plane.png');
						style.getIconStyle().setIcon(icon); //применяет значок к стилю
						placemark.setStyleSelector(style); //применяет стиль к метке
						
						
						
						lineStringPlacemark.setGeometry(lineString);
						lineString.setExtrude(true);
						lineString.setAltitudeMode(ge.ALTITUDE_ABSOLUTE);
						lineStringPlacemark.setStyleSelector(ge.createStyle(''));
						lineStyle = lineStringPlacemark.getStyleSelector().getLineStyle();
						lineStyle.setWidth(5);
						lineStyle.getColor().set('9900ffff');  // формат aabbggrr
						flCreP=1;
					}
					placemark.setName("Current altitude "+reCord.altitude+ " m");
					
					if(document.getElementById('ctrlTracking').checked) {
						la.set(Number(reCord.latitude),Number(reCord.longitude), 0, ge.ALTITUDE_RELATIVE_TO_GROUND, 0, 70, (Number(reCord.altitude)*4));
						ge.getView().setAbstractView(la);
					}
					
					point.setLatitude(Number(reCord.latitude));
					point.setLongitude(Number(reCord.longitude));
					point.setAltitudeMode(ge.ALTITUDE_ABSOLUTE);
					point.setAltitude(Number(reCord.altitude));
					placemark.setGeometry(point);
					ge.getFeatures().appendChild(placemark);

					lineString.getCoordinates().clear();
					lineString.getCoordinates().pushLatLngAlt(Number(reCord.latitude), Number(reCord.longitude), Number(reCord.altitude));
					
					

					ge.getFeatures().appendChild(lineStringPlacemark);
//					clearInterval(refIntId);
				
			}
			//^^^^^^^^^^^^^^^^^^^^^^^^^It's all GOOGLE EARTH^^^^^^^^^^^^^^^^^^^^^^^^^^
			
			//--------------------------------It's all GOOGLE MAPS---------------------------------
		function initialize() {
		
			var mapOptions = {
				center: new google.maps.LatLng(49.999, 36.250),
				zoom: 17,
				scaleControl: true,
				zoomControlOptions: {
					style: google.maps.ZoomControlStyle.DEFAULT
				},
				mapTypeId: google.maps.MapTypeId.HYBRID
			};
			var map = new google.maps.Map(document.getElementById("map_canvas"),
				mapOptions);      

			google.maps.event.addDomListener(window, 'load', initialize);
		}

			//^^^^^^^^^^^^^^^^^^^^^^^^^^It's all GOOGLE MAPS^^^^^^^^^^^^^^^^^^^^^^^^^^
			
			//-------------------------------PAGES BLOCK--------------------------------------------
			var maps_flag=0;
			function showPage(numPage) {
				//alert(numPage);
				if(numPage==0) {
					document.getElementById("main_page").style.display="none";
					document.getElementById("db_settings").style.display="none";
					document.getElementById("GoogleEarth").style.display="block";
					document.getElementById("GoogleMaps").style.display="none";
					document.getElementById("UnionPage").style.display="none";
				}
				if(numPage==1) {
					document.getElementById("db_settings").style.display="block";
					document.getElementById("main_page").style.display="none";
					document.getElementById("GoogleEarth").style.display="none";
					document.getElementById("GoogleMaps").style.display="none";
					document.getElementById("UnionPage").style.display="none";
				}
				if(numPage==2) {
					document.getElementById("db_settings").style.display="none";
					document.getElementById("GoogleEarth").style.display="none";
					document.getElementById("main_page").style.display="block";
					document.getElementById("GoogleMaps").style.display="none";
					document.getElementById("UnionPage").style.display="none";
				}
				if(numPage==3) {
					document.getElementById("GoogleMaps").style.display="block";
					document.getElementById("db_settings").style.display="none";
					document.getElementById("GoogleEarth").style.display="none";
					document.getElementById("main_page").style.display="none";
					document.getElementById("UnionPage").style.display="none";
					if(maps_flag==0) {
						initialize();
						maps_flag=1;
					}
				}
				if(numPage==4) {
					document.getElementById("UnionPage").style.display="block";
					document.getElementById("GoogleMaps").style.display="none";
					document.getElementById("db_settings").style.display="none";
					document.getElementById("GoogleEarth").style.display="none";
					document.getElementById("main_page").style.display="none";
					if(maps_flag==0) {
						initialize();
						maps_flag=1;
					}
				}
			}
			//^^^^^^^^^^^^^^^^^^^^^^^^^PAGES BLOCK^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
		</script>

	</head>
	<body>
		<section id="main_menu">
			<p align=center><input type="button" id="mm_mp" value="Main Page" onclick="showPage(2)">&nbsp
									<input type="button" id="mm_ge" value="Google Earth" onclick="showPage(0)">&nbsp
									<input type="button" id="mm_gm" value="Google Maps" onclick="showPage(3)">&nbsp
									<input type="button" id="mm_cp" value="Control Page" onclick="showPage(4)">&nbsp
									<input type="button" id="mm_set" value="Database settings" onclick="showPage(1)"></p>
		</section>
		<section id="main_page">
			<p align=center>It's main page. You can choose one of menu buttons. And may the force be with you!</br>
			<img src="http://imgs.steps.dragoart.com/how-to-draw-chibi-darth-vader-step-6_1_000000013000_5.jpg" width=200px></p>
			
		</section>
		<section id="GoogleEarth" class="hidden">
			<div id="ge_menu">
				<!--<input type="button" onclick="go()" id='sCenter' value="Go" /> кнопка одиночного запуска слежения, без таймера-->
				&nbsp <input type="checkbox" onclick="timerSet()" id="ctrlReGetPosition" value="Load position">Observation
				&nbsp <input type="checkbox" id="ctrlTracking" value="Load position">Tracking 
				<!--&nbsp <input type="checkbox" onclick="gps()" id="ctrlGPS" value="Load position">Test GPS data -->
			</div>
			<div id="map3d"></div>
		</section>
		<section id="db_settings" class="hidden">
			Change DB connection settings</br>
			Set database host: <input type="text" id="DB_host"></br>
			Set username: <input type="text" id="DB_user"></br>
			Set password: <input type="password" id="DB_pass"></br>
			Set database name: <input type="text" id="DB_name"></br>
			<input type="button" id="DB_submit" value="Set">
		</section>
		<section id="GoogleMaps" class="hidden">
			<div id="gm_menu">
				<input type="button" id="ctrlCreate" value="Create a path"> 
				&nbsp <input type="checkbox" id="ctrlReGetPosition" value="Load position">Load position 
				&nbsp <input type="button" id="ctrlClear" value="Clear map" onclick="reInitialize()">
			</div>
			<div id="map_canvas"></div>
		</section>
		<section id="UnionPage" class="hidden">
			<!---->
			<div id="up_right">
				<div id="up_gEarth">
					<h3>Earth</h3>
				</div>
				<div id="up_gMaps">
					Maps
				</div>
			</div>
			<div id="up_left">
				<div id="up_cameras">
					<h3>Cameras</h3>
				</div>
				<div id="nav_data">
					<h3>Navigation</h3>
				</div>
				<div id="up_controls">
					<h2>Controls</h2>
				</div>
			</div>
		<!--	-->
		</section>
	</body>
</html>